<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MongoDB URI Console</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #0c1118;
            --panel: #141c27;
            --accent: #00ed64;
            --text: #f5f5f5;
            --muted: #7c8a9a;
            --error: #ff4d4f;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", system-ui, sans-serif;
            background: linear-gradient(135deg, rgba(12,17,24,0.95), rgba(10,30,50,0.95)), url("https://www.mongodb.com/assets/images/global/leaf-dark.svg");
            background-size: cover;
            min-height: 100vh;
            color: var(--text);
            padding: 2rem;
        }

        h1, h2 {
            margin-top: 0;
            color: var(--accent);
        }

        h2 {
            font-size: 1.1rem;
        }

        .app {
            max-width: 1100px;
            margin: 0 auto;
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .panel {
            background: rgba(20, 28, 39, 0.93);
            border: 1px solid rgba(0, 237, 100, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(8px);
            box-shadow: 0 18px 30px rgba(0, 0, 0, 0.35);
        }

        .panel.primary {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.35rem;
            color: var(--muted);
        }

        input, textarea {
            width: 100%;
            border-radius: 8px;
            background: rgba(12, 17, 24, 0.75);
            border: 1px solid rgba(124, 138, 154, 0.3);
            color: var(--text);
            font-size: 0.95rem;
            padding: 0.65rem 0.85rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: rgba(0, 237, 100, 0.6);
            box-shadow: 0 0 0 2px rgba(0, 237, 100, 0.15);
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.45rem;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #00ed64, #02c26a);
            color: #04110b;
            font-weight: 600;
            letter-spacing: 0.02em;
            padding: 0.65rem 1.4rem;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        button:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 12px 26px rgba(0, 237, 100, 0.25);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .status.ok {
            color: var(--accent);
        }

        .status.error {
            color: var(--error);
        }

        pre {
            border-radius: 8px;
            background: rgba(12, 17, 24, 0.8);
            border: 1px solid rgba(124, 138, 154, 0.3);
            padding: 0.8rem;
            font-size: 0.9rem;
            max-height: 260px;
            overflow: auto;
        }

        .notice {
            background: rgba(0, 237, 100, 0.12);
            border: 1px solid rgba(0, 237, 100, 0.25);
            border-radius: 10px;
            padding: 0.85rem 1rem;
            margin-bottom: 1.25rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .inline {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .inline button {
            flex: none;
        }

        .grid-layout {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        small {
            color: var(--muted);
        }

        @media (max-width: 680px) {
            body {
                padding: 1.2rem;
            }

            .app {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <main class="app">
        <section class="panel primary">
            <h1>MongoDB URI Console</h1>
            <p class="notice">
                This standalone page uses the MongoDB Atlas Data API so you can explore a cluster directly from the browser.
                Make sure the Data API is enabled for your project and that this origin is on the allowed list. Never share
                permanent keys here; create short-lived keys when possible.
            </p>
            <form id="connection-form">
                <label for="api-uri">MongoDB Data API URI</label>
                <input id="api-uri" name="api-uri" type="url" required placeholder="https://data.mongodb-api.com/app/data-xxxxx/endpoint/data/v1" />

                <label for="api-key">API Key</label>
                <input id="api-key" name="api-key" type="password" required placeholder="Your Data API key" />

                <div class="grid-layout">
                    <div>
                        <label for="data-source">Data Source</label>
                        <input id="data-source" name="data-source" required placeholder="Cluster0" />
                    </div>
                    <div>
                        <label for="database-name">Database</label>
                        <input id="database-name" name="database-name" required placeholder="sample_mflix" />
                    </div>
                    <div>
                        <label for="collection-name">Collection</label>
                        <input id="collection-name" name="collection-name" required placeholder="movies" />
                    </div>
                </div>

                <div class="inline">
                    <button type="submit" id="connect-btn">Connect</button>
                    <small id="connection-status" class="status"></small>
                </div>
            </form>
        </section>

        <section class="panel">
            <h2>Find Documents</h2>
            <label for="find-filter">Filter (JSON)</label>
            <textarea id="find-filter" placeholder="{}"></textarea>

            <label for="find-projection">Projection (JSON)</label>
            <textarea id="find-projection" placeholder="{}"></textarea>

            <button id="execute-find">Run Find</button>
            <pre id="find-result">Awaiting query...</pre>
        </section>

        <section class="panel">
            <h2>Insert Document</h2>
            <label for="insert-document">Document (JSON)</label>
            <textarea id="insert-document" placeholder='{"title": "New movie", "year": 2025}'></textarea>

            <button id="execute-insert">Insert One</button>
            <pre id="insert-result">No insert yet.</pre>
        </section>

        <section class="panel">
            <h2>Update Document</h2>
            <label for="update-filter">Filter (JSON)</label>
            <textarea id="update-filter" placeholder='{"_id": {"$oid": "64ff..."}}'></textarea>

            <label for="update-document">Update (JSON)</label>
            <textarea id="update-document" placeholder='{"$set": {"title": "Updated"}}'></textarea>

            <button id="execute-update">Update One</button>
            <pre id="update-result">No update yet.</pre>
        </section>

        <section class="panel">
            <h2>Delete Document</h2>
            <label for="delete-filter">Filter (JSON)</label>
            <textarea id="delete-filter" placeholder='{"_id": {"$oid": "64ff..."}}'></textarea>

            <button id="execute-delete">Delete One</button>
            <pre id="delete-result">No delete yet.</pre>
        </section>
    </main>

    <template id="spinner-template">
        <span>Working...</span>
    </template>

    <script>
        const state = {
            baseUri: "",
            apiKey: "",
            dataSource: "",
            database: "",
            collection: "",
            isConnected: false
        };

        const form = document.getElementById("connection-form");
        const statusEl = document.getElementById("connection-status");
        const connectBtn = document.getElementById("connect-btn");
        const findResult = document.getElementById("find-result");
        const insertResult = document.getElementById("insert-result");
        const updateResult = document.getElementById("update-result");
        const deleteResult = document.getElementById("delete-result");

        function persistentLoad() {
            try {
                const saved = JSON.parse(localStorage.getItem("mongo-data-api-config"));
                if (!saved) {
                    return;
                }
                state.baseUri = saved.baseUri || "";
                state.apiKey = saved.apiKey || "";
                state.dataSource = saved.dataSource || "";
                state.database = saved.database || "";
                state.collection = saved.collection || "";

                document.getElementById("api-uri").value = state.baseUri;
                document.getElementById("api-key").value = state.apiKey;
                document.getElementById("data-source").value = state.dataSource;
                document.getElementById("database-name").value = state.database;
                document.getElementById("collection-name").value = state.collection;
            } catch (err) {
                console.warn("Unable to load cached config", err);
            }
        }

        function persistentSave() {
            localStorage.setItem("mongo-data-api-config", JSON.stringify({
                baseUri: state.baseUri,
                apiKey: state.apiKey,
                dataSource: state.dataSource,
                database: state.database,
                collection: state.collection
            }));
        }

        persistentLoad();

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            statusEl.textContent = "Connecting...";
            statusEl.className = "status";
            connectBtn.disabled = true;

            state.baseUri = document.getElementById("api-uri").value.trim().replace(/\/?$/, "");
            state.apiKey = document.getElementById("api-key").value.trim();
            state.dataSource = document.getElementById("data-source").value.trim();
            state.database = document.getElementById("database-name").value.trim();
            state.collection = document.getElementById("collection-name").value.trim();

            persistentSave();

            const canProceed = await pingCluster();
            connectBtn.disabled = false;
            if (canProceed) {
                state.isConnected = true;
                statusEl.textContent = "Connected. Ready for CRUD operations.";
                statusEl.className = "status ok";
                findDocuments();
            } else {
                state.isConnected = false;
            }
        });

        async function pingCluster() {
            try {
                await callDataApi("findOne", { filter: {} });
                return true;
            } catch (error) {
                statusEl.textContent = error.message;
                statusEl.className = "status error";
                return false;
            }
        }

        function parseJson(source, fallback = {}) {
            if (!source.trim()) {
                return fallback;
            }
            try {
                return JSON.parse(source);
            } catch (err) {
                throw new Error("Invalid JSON payload.");
            }
        }

        async function callDataApi(action, payload) {
            if (!state.baseUri || !state.apiKey) {
                throw new Error("Please connect first.");
            }

            const endpoint = `${state.baseUri}/action/${action}`;
            const body = {
                dataSource: state.dataSource,
                database: state.database,
                collection: state.collection,
                ...payload
            };

            const response = await fetch(endpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "api-key": state.apiKey
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const text = await response.text();
                throw new Error(`Data API error (${response.status}): ${text}`);
            }

            return response.json();
        }

        async function findDocuments() {
            const filterText = document.getElementById("find-filter").value;
            const projectionText = document.getElementById("find-projection").value;

            try {
                const filter = parseJson(filterText, {});
                const projection = parseJson(projectionText, {});
                findResult.textContent = "Loading...";
                const data = await callDataApi("find", { filter, projection, limit: 25 });
                findResult.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                findResult.textContent = err.message;
            }
        }

        async function insertDocument() {
            const source = document.getElementById("insert-document").value;
            try {
                const document = parseJson(source);
                insertResult.textContent = "Inserting...";
                const data = await callDataApi("insertOne", { document });
                insertResult.textContent = JSON.stringify(data, null, 2);
                await findDocuments();
            } catch (err) {
                insertResult.textContent = err.message;
            }
        }

        async function updateDocument() {
            const filterSource = document.getElementById("update-filter").value;
            const updateSource = document.getElementById("update-document").value;
            try {
                const filter = parseJson(filterSource);
                const update = parseJson(updateSource);
                updateResult.textContent = "Updating...";
                const data = await callDataApi("updateOne", { filter, update });
                updateResult.textContent = JSON.stringify(data, null, 2);
                await findDocuments();
            } catch (err) {
                updateResult.textContent = err.message;
            }
        }

        async function deleteDocument() {
            const filterSource = document.getElementById("delete-filter").value;
            try {
                const filter = parseJson(filterSource);
                deleteResult.textContent = "Deleting...";
                const data = await callDataApi("deleteOne", { filter });
                deleteResult.textContent = JSON.stringify(data, null, 2);
                await findDocuments();
            } catch (err) {
                deleteResult.textContent = err.message;
            }
        }

        document.getElementById("execute-find").addEventListener("click", () => {
            if (!state.isConnected) {
                statusEl.textContent = "Connect first.";
                statusEl.className = "status error";
                return;
            }
            findDocuments();
        });

        document.getElementById("execute-insert").addEventListener("click", () => {
            if (!state.isConnected) {
                statusEl.textContent = "Connect first.";
                statusEl.className = "status error";
                return;
            }
            insertDocument();
        });

        document.getElementById("execute-update").addEventListener("click", () => {
            if (!state.isConnected) {
                statusEl.textContent = "Connect first.";
                statusEl.className = "status error";
                return;
            }
            updateDocument();
        });

        document.getElementById("execute-delete").addEventListener("click", () => {
            if (!state.isConnected) {
                statusEl.textContent = "Connect first.";
                statusEl.className = "status error";
                return;
            }
            deleteDocument();
        });
    </script>
</body>
</html>
