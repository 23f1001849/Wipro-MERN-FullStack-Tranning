<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MongoDB URI Console</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #0c1118;
            --panel: #141c27;
            --accent: #00ed64;
            --text: #f5f5f5;
            --muted: #7c8a9a;
            --error: #ff4d4f;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", system-ui, sans-serif;
            background: linear-gradient(135deg, rgba(12,17,24,0.95), rgba(10,30,50,0.95)), url("https://www.mongodb.com/assets/images/global/leaf-dark.svg");
            background-size: cover;
            min-height: 100vh;
            color: var(--text);
            padding: 2rem;
        }

        h1, h2 {
            margin-top: 0;
            color: var(--accent);
        }

        h2 {
            font-size: 1.1rem;
        }

        .app {
            max-width: 1100px;
            margin: 0 auto;
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .panel {
            background: rgba(20, 28, 39, 0.93);
            border: 1px solid rgba(0, 237, 100, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(8px);
            box-shadow: 0 18px 30px rgba(0, 0, 0, 0.35);
        }

        .panel.primary {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.35rem;
            color: var(--muted);
        }

        input, textarea {
            width: 100%;
            border-radius: 8px;
            background: rgba(12, 17, 24, 0.75);
            border: 1px solid rgba(124, 138, 154, 0.3);
            color: var(--text);
            font-size: 0.95rem;
            padding: 0.65rem 0.85rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: rgba(0, 237, 100, 0.6);
            box-shadow: 0 0 0 2px rgba(0, 237, 100, 0.15);
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.45rem;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #00ed64, #02c26a);
            color: #04110b;
            font-weight: 600;
            letter-spacing: 0.02em;
            padding: 0.65rem 1.4rem;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        button:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 12px 26px rgba(0, 237, 100, 0.25);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .status.ok {
            color: var(--accent);
        }

        .status.error {
            color: var(--error);
        }

        pre {
            border-radius: 8px;
            background: rgba(12, 17, 24, 0.8);
            border: 1px solid rgba(124, 138, 154, 0.3);
            padding: 0.8rem;
            font-size: 0.9rem;
            max-height: 260px;
            overflow: auto;
        }

        .notice {
            background: rgba(0, 237, 100, 0.12);
            border: 1px solid rgba(0, 237, 100, 0.25);
            border-radius: 10px;
            padding: 0.85rem 1rem;
            margin-bottom: 1.25rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .inline {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .inline button {
            flex: none;
        }

        .config-preview {
            border-radius: 10px;
            border: 1px solid rgba(0, 237, 100, 0.2);
            background: rgba(12, 17, 24, 0.6);
            padding: 1rem 1.25rem;
            margin-bottom: 1.1rem;
        }

        .config-preview dl {
            margin: 0;
            display: grid;
            gap: 0.35rem;
        }

        .config-preview dt {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(124, 138, 154, 0.9);
        }

        .config-preview dd {
            margin: 0 0 0.5rem;
            font-weight: 600;
            word-break: break-all;
            color: var(--text);
        }

        .config-preview dd:last-of-type {
            margin-bottom: 0;
        }

        small {
            color: var(--muted);
        }

        @media (max-width: 680px) {
            body {
                padding: 1.2rem;
            }

            .app {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <main class="app">
        <section class="panel primary">
            <h1>MongoDB URI Console</h1>
            <p class="notice">
                This console talks to a local Node.js proxy that performs MongoDB driver calls on your behalf. Run the
                <code>connect.js</code> server first (the proxy handles credentials stored in <code>.env</code>), then connect below to trigger live CRUD helpers.
            </p>
            <form id="connection-form">
                <div class="config-preview" aria-live="polite">
                    <p class="muted" id="env-status">Contacting local Node server for configuration...</p>
                    <dl>
                        <dt>Deployment</dt>
                        <dd id="env-uri">...</dd>
                        <dt>Database</dt>
                        <dd id="env-database">...</dd>
                        <dt>Collection</dt>
                        <dd id="env-collection">...</dd>
                    </dl>
                </div>

                <div class="inline">
                    <button type="submit" id="connect-btn">Connect</button>
                    <small id="connection-status" class="status"></small>
                </div>
            </form>
        </section>

        <section class="panel">
            <h2>Find Documents</h2>
            <label for="find-filter">Filter (JSON)</label>
            <textarea id="find-filter" placeholder="{}"></textarea>

            <label for="find-projection">Projection (JSON)</label>
            <textarea id="find-projection" placeholder="{}"></textarea>

            <button id="execute-find">Run Find</button>
            <pre id="find-result">Awaiting query...</pre>
        </section>

        <section class="panel">
            <h2>Insert Document</h2>
            <label for="insert-document">Document (JSON)</label>
            <textarea id="insert-document" placeholder='{"title": "New movie", "year": 2025}'></textarea>

            <button id="execute-insert">Insert One</button>
            <pre id="insert-result">No insert yet.</pre>
        </section>

        <section class="panel">
            <h2>Update Document</h2>
            <label for="update-filter">Filter (JSON)</label>
            <textarea id="update-filter" placeholder='{"_id": {"$oid": "64ff..."}}'></textarea>

            <label for="update-document">Update (JSON)</label>
            <textarea id="update-document" placeholder='{"$set": {"title": "Updated"}}'></textarea>

            <button id="execute-update">Update One</button>
            <pre id="update-result">No update yet.</pre>
        </section>

        <section class="panel">
            <h2>Delete Document</h2>
            <label for="delete-filter">Filter (JSON)</label>
            <textarea id="delete-filter" placeholder='{"_id": {"$oid": "64ff..."}}'></textarea>

            <button id="execute-delete">Delete One</button>
            <pre id="delete-result">No delete yet.</pre>
        </section>
    </main>

    <template id="spinner-template">
        <span>Working...</span>
    </template>

    <script>
        const state = {
            database: "",
            collection: "",
            isConnected: false,
            envLoaded: false
        };

        const form = document.getElementById("connection-form");
        const statusEl = document.getElementById("connection-status");
        const connectBtn = document.getElementById("connect-btn");
        const findResult = document.getElementById("find-result");
        const insertResult = document.getElementById("insert-result");
        const updateResult = document.getElementById("update-result");
        const deleteResult = document.getElementById("delete-result");
        const envStatus = document.getElementById("env-status");
        const envUri = document.getElementById("env-uri");
        const envDatabase = document.getElementById("env-database");
        const envCollection = document.getElementById("env-collection");

        connectBtn.disabled = true;

        async function loadServerConfig() {
            try {
                const response = await fetch("/api/config", { cache: "no-store" });
                if (!response.ok) {
                    throw new Error(`${response.status} ${response.statusText}`);
                }
                const config = await response.json();

                state.database = (config.database || "").trim();
                state.collection = (config.collection || "").trim();
                state.envLoaded = Boolean(state.database && state.collection);

                envUri.textContent = config.deployment || "Managed on server";
                envDatabase.textContent = state.database || "Not set";
                envCollection.textContent = state.collection || "Not set";

                if (state.envLoaded) {
                    envStatus.textContent = "Configuration supplied by server.";
                    envStatus.className = "muted";
                    connectBtn.disabled = false;
                } else {
                    throw new Error("Missing required values on the server. Ensure database and collection are defined.");
                }
            } catch (error) {
                state.envLoaded = false;
                envStatus.textContent = `Unable to reach Node server: ${error.message}`;
                envStatus.className = "status error";
                envUri.textContent = "Unavailable";
                envDatabase.textContent = "Unavailable";
                envCollection.textContent = "Unavailable";
                connectBtn.disabled = true;
            }
        }

        loadServerConfig();

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            if (!state.envLoaded) {
                envStatus.textContent = "Server configuration not ready. Resolve the issue above and refresh.";
                envStatus.className = "status error";
                return;
            }
            statusEl.textContent = "Connecting...";
            statusEl.className = "status";
            connectBtn.disabled = true;

            try {
                const response = await fetch("/api/ping");
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error || "Ping failed.");
                }
                state.isConnected = true;
                statusEl.textContent = "Connected. Ready for CRUD operations.";
                statusEl.className = "status ok";
                findDocuments();
            } catch (error) {
                state.isConnected = false;
                statusEl.textContent = error.message;
                statusEl.className = "status error";
            } finally {
                connectBtn.disabled = false;
            }
        });

        function parseJson(source, fallback = {}) {
            if (!source.trim()) {
                return fallback;
            }
            try {
                return JSON.parse(source);
            } catch (err) {
                throw new Error("Invalid JSON payload.");
            }
        }

        async function callBackend(path, payload) {
            const response = await fetch(path, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                const message = errorBody.error || `Server error (${response.status})`;
                throw new Error(message);
            }

            return response.json();
        }

        async function findDocuments() {
            const filterText = document.getElementById("find-filter").value;
            const projectionText = document.getElementById("find-projection").value;

            try {
                const filter = parseJson(filterText, {});
                const projection = parseJson(projectionText, {});
                findResult.textContent = "Loading...";
                const data = await callBackend("/api/find", { filter, projection, limit: 25 });
                findResult.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                findResult.textContent = err.message;
            }
        }

        async function insertDocument() {
            const source = document.getElementById("insert-document").value;
            try {
                const document = parseJson(source);
                insertResult.textContent = "Inserting...";
                const data = await callBackend("/api/insert", { document });
                insertResult.textContent = JSON.stringify(data, null, 2);
                await findDocuments();
            } catch (err) {
                insertResult.textContent = err.message;
            }
        }

        async function updateDocument() {
            const filterSource = document.getElementById("update-filter").value;
            const updateSource = document.getElementById("update-document").value;
            try {
                const filter = parseJson(filterSource);
                const update = parseJson(updateSource);
                updateResult.textContent = "Updating...";
                const data = await callBackend("/api/update", { filter, update });
                updateResult.textContent = JSON.stringify(data, null, 2);
                await findDocuments();
            } catch (err) {
                updateResult.textContent = err.message;
            }
        }

        async function deleteDocument() {
            const filterSource = document.getElementById("delete-filter").value;
            try {
                const filter = parseJson(filterSource);
                deleteResult.textContent = "Deleting...";
                const data = await callBackend("/api/delete", { filter });
                deleteResult.textContent = JSON.stringify(data, null, 2);
                await findDocuments();
            } catch (err) {
                deleteResult.textContent = err.message;
            }
        }

        document.getElementById("execute-find").addEventListener("click", () => {
            if (!state.isConnected) {
                statusEl.textContent = "Connect first.";
                statusEl.className = "status error";
                return;
            }
            findDocuments();
        });

        document.getElementById("execute-insert").addEventListener("click", () => {
            if (!state.isConnected) {
                statusEl.textContent = "Connect first.";
                statusEl.className = "status error";
                return;
            }
            insertDocument();
        });

        document.getElementById("execute-update").addEventListener("click", () => {
            if (!state.isConnected) {
                statusEl.textContent = "Connect first.";
                statusEl.className = "status error";
                return;
            }
            updateDocument();
        });

        document.getElementById("execute-delete").addEventListener("click", () => {
            if (!state.isConnected) {
                statusEl.textContent = "Connect first.";
                statusEl.className = "status error";
                return;
            }
            deleteDocument();
        });
    </script>
</body>
</html>
